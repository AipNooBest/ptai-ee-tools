<div>
<p>Название основной задачи анализа кода. Задача представляет собой pipeline-скрипт с четырьмя параметрами:</p>
<p>PTAI_PROJECT_NAME - наименование проекта во вьювере PT AI</p>
<p>PTAI_NODE_NAME - наименование или тег узла CI, на котором должен осуществляться анализ кода</p>
<p>PTAI_SETTINGS_JSON - параметры анализа, представленные в формате JSON</p>
<p>PTAI_POLICY_JSON - политика безопасности проекта, представленная в формате JSON</p>
<p>Необходимо отключить опцию Groovy sandbox. Рекомендованный скрипт:</p>
<!-- HTML generated using hilite.me --><!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #00aaaa">def</span> aicPath = <span style="color: #aa5500">&#39;C:\\Program Files (x86)\\Positive Technologies\\Application Inspector Agent\\aic.exe&#39;</span>
node(<span style="color: #aa5500">&quot;${PTAI_NODE_NAME}&quot;</span>) {
    <span style="color: #00aaaa">def</span> retStatus = <span style="color: #009999">0</span>;

    stage(<span style="color: #aa5500">&#39;SAST&#39;</span>) {
        <span style="color: #0000aa">if</span> (isUnix()) {
            currentBuild.<span style="color: #1e90ff">result</span> = <span style="color: #aa5500">&quot;UNSTABLE&quot;</span>;
            println <span style="color: #aa5500">&#39;PT AI must be deployed on a Windows host&#39;</span>;
            <span style="color: #0000aa">return</span>;
        }
        cleanWs();

        batchScript = <span style="color: #aa5500">&quot;\&quot;${aicPath}\&quot; &quot;</span>;
        batchScript += <span style="color: #aa5500">&quot;--project-name \&quot;${PTAI_PROJECT_NAME}\&quot; &quot;</span>;
        batchScript += <span style="color: #aa5500">&quot;--scan-target \&quot;${WORKSPACE}\\SCAN\&quot; &quot;</span>
        batchScript += <span style="color: #aa5500">&quot;--reports \&quot;HTML|JSON\&quot; &quot;</span>
        batchScript += <span style="color: #aa5500">&quot;--reports-folder \&quot;${WORKSPACE}\\REPORTS\&quot; &quot;</span>
        batchScript += <span style="color: #aa5500">&quot;--restore-sources &quot;</span>
        batchScript += <span style="color: #aa5500">&quot;--sync &quot;</span>
        <span style="color: #0000aa">if</span> (<span style="color: #aa5500">&quot;${PTAI_SETTINGS_JSON}&quot;</span>?.<span style="color: #1e90ff">trim</span>()) {
            writeFile file: <span style="color: #aa5500">&quot;${WORKSPACE}\\SETTINGS\\settings.aiproj&quot;</span>, text: <span style="color: #aa5500">&quot;${PTAI_SETTINGS_JSON}&quot;</span>
            batchScript += <span style="color: #aa5500">&quot;--project-settings-file \&quot;${WORKSPACE}\\SETTINGS\\settings.aiproj\&quot; &quot;</span>
        }

        <span style="color: #0000aa">if</span> (<span style="color: #aa5500">&quot;${PTAI_POLICY_JSON}&quot;</span>?.<span style="color: #1e90ff">trim</span>()) {
            writeFile file: <span style="color: #aa5500">&quot;${WORKSPACE}\\SETTINGS\\policy.json&quot;</span>, text: <span style="color: #aa5500">&quot;${PTAI_POLICY_JSON}&quot;</span>
            batchScript += <span style="color: #aa5500">&quot;--policies-path \&quot;${WORKSPACE}\\SETTINGS\\policy.json\&quot; &quot;</span>
        }

        retStatus = bat(script: batchScript, returnStatus: <span style="color: #0000aa">true</span>);
		writeFile file: <span style="color: #aa5500">&quot;${WORKSPACE}\\REPORTS\\status.code&quot;</span>, text: <span style="color: #aa5500">&quot;${retStatus}&quot;</span>
        println <span style="color: #aa5500">&quot;AI return status ${retStatus}&quot;</span>;
        archiveArtifacts <span style="color: #aa5500">&#39;REPORTS/*&#39;</span>;

        <span style="color: #0000aa">if</span> (<span style="color: #009999">0</span> == retStatus) {
            currentBuild.<span style="color: #1e90ff">result</span> = <span style="color: #aa5500">&quot;SUCCESS&quot;</span>;
            println <span style="color: #aa5500">&#39;SAST policy assessment OK&#39;</span>;
        } <span style="color: #0000aa">else</span> <span style="color: #0000aa">if</span> (<span style="color: #009999">10</span> == retStatus) {
            currentBuild.<span style="color: #1e90ff">result</span> = <span style="color: #aa5500">&quot;FAILURE&quot;</span>;
            println <span style="color: #aa5500">&#39;SAST policy assessment failed&#39;</span>;
        } <span style="color: #0000aa">else</span> <span style="color: #0000aa">if</span> (-<span style="color: #009999">1</span> == retStatus) {
            currentBuild.<span style="color: #1e90ff">result</span> = <span style="color: #aa5500">&quot;UNSTABLE&quot;</span>;
            println <span style="color: #aa5500">&#39;Another AI instance started already&#39;</span>;
        } <span style="color: #0000aa">else</span> <span style="color: #0000aa">if</span> (<span style="color: #009999">2</span> == retStatus) {
            currentBuild.<span style="color: #1e90ff">result</span> = <span style="color: #aa5500">&quot;UNSTABLE&quot;</span>;
            println <span style="color: #aa5500">&#39;Scan folder not found&#39;</span>;
        } <span style="color: #0000aa">else</span> <span style="color: #0000aa">if</span> (<span style="color: #009999">3</span> == retStatus) {
            currentBuild.<span style="color: #1e90ff">result</span> = <span style="color: #aa5500">&quot;UNSTABLE&quot;</span>;
            println <span style="color: #aa5500">&#39;AI license problem&#39;</span>;
        } <span style="color: #0000aa">else</span> <span style="color: #0000aa">if</span> (<span style="color: #009999">4</span> == retStatus) {
            currentBuild.<span style="color: #1e90ff">result</span> = <span style="color: #aa5500">&quot;UNSTABLE&quot;</span>;
            println <span style="color: #aa5500">&#39;Project not found&#39;</span>;
        } <span style="color: #0000aa">else</span> <span style="color: #0000aa">if</span> (<span style="color: #009999">5</span> == retStatus) {
            currentBuild.<span style="color: #1e90ff">result</span> = <span style="color: #aa5500">&quot;UNSTABLE&quot;</span>;
            println <span style="color: #aa5500">&#39;Project settings error&#39;</span>;
        } <span style="color: #0000aa">else</span> <span style="color: #0000aa">if</span> (<span style="color: #009999">6</span> == retStatus) {
            currentBuild.<span style="color: #1e90ff">result</span> = <span style="color: #aa5500">&quot;UNSTABLE&quot;</span>;
            println <span style="color: #aa5500">&#39;Minor errors during scan&#39;</span>;
        } <span style="color: #0000aa">else</span> {
            currentBuild.<span style="color: #1e90ff">result</span> = <span style="color: #aa5500">&quot;FAILURE&quot;</span>;
            println <span style="color: #aa5500">&#39;Unknown problem&#39;</span>;
        }
        cleanWs();
    }
}
</pre></div>
</div>
